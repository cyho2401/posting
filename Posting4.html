<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CEDD Staff Management System</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f6fa;
      color: #333;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white;
      padding: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .header h1 {
      font-size: 2.2rem;
      margin-bottom: 5px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1rem;
    }

    /* Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Cards */
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .card h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }

    .tab-button {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .tab-button:hover {
      color: #3498db;
    }

    .tab-button.active {
      color: #3498db;
      border-bottom-color: #3498db;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Filter Section */
    .filter-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .filter-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    .filter-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      margin-bottom: 8px;
    }

    .filter-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    /* Rank Filter Buttons */
    .rank-filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .rank-filter-btn {
      padding: 8px 16px;
      background: #e0e0e0;
      border: 2px solid transparent;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      color: #666;
    }

    .rank-filter-btn:hover {
      background: #d0d0d0;
    }

    .rank-filter-btn.active {
      background: #3498db;
      color: white;
      border-color: #2980b9;
    }

    .rank-filter-btn.engineer {
      background: #e8d4f1;
      color: #8e44ad;
    }

    .rank-filter-btn.engineer.active {
      background: #9b59b6;
      color: white;
    }

    .rank-filter-btn.director {
      background: #fdebd0;
      color: #e67e22;
    }

    .rank-filter-btn.director.active {
      background: #f39c12;
      color: white;
    }

    .rank-filter-btn.chief {
      background: #fadbd8;
      color: #c0392b;
    }

    .rank-filter-btn.chief.active {
      background: #e74c3c;
      color: white;
    }

    /* Department/Office Groups */
    .department-group {
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
    }

    .department-header {
      background: #34495e;
      color: white;
      padding: 15px 20px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .department-header:hover {
      background: #2c3e50;
    }

    .department-count {
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
    }

    .office-group {
      border-bottom: 1px solid #e0e0e0;
    }

    .office-group:last-child {
      border-bottom: none;
    }

    .office-header {
      background: #ecf0f1;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .office-header:hover {
      background: #d5dbdb;
    }

    .office-count {
      background: #3498db;
      color: white;
      padding: 3px 10px;
      border-radius: 10px;
      font-size: 13px;
    }

    .staff-list {
      background: white;
    }

    .staff-item {
      padding: 12px 20px;
      border-bottom: 1px solid #f0f0f0;
      display: grid;
      grid-template-columns: 30px 1fr 2fr 120px 120px 100px;
      gap: 15px;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .staff-item:hover {
      background: #f8f9fa;
      transform: translateX(5px);
    }

    .staff-item:last-child {
      border-bottom: none;
    }

    .staff-number {
      color: #666;
      font-size: 13px;
    }

    .staff-name {
      font-weight: 600;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .staff-title {
      color: #666;
    }

    .staff-tel {
      color: #666;
      font-size: 14px;
    }

    .staff-postings {
      text-align: center;
    }

    .staff-actions {
      display: flex;
      gap: 5px;
    }

    /* Badges */
    .rank-badge {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .engineer-badge {
      background: #9b59b6;
      color: white;
    }

    .director-badge {
      background: #f39c12;
      color: white;
    }

    .chief-badge {
      background: #e74c3c;
      color: white;
    }

    .posting-match {
      background: #27ae60;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .duplicate-indicator {
      background: #3498db;
      color: white;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
    }

    /* Action Buttons */
    .action-btn {
      padding: 4px 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: white;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .action-btn:hover {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }

    .action-btn.match {
      border-color: #27ae60;
      color: #27ae60;
    }

    .action-btn.match:hover {
      background: #27ae60;
      color: white;
    }

    .action-btn.unmatch {
      border-color: #e74c3c;
      color: #e74c3c;
    }

    .action-btn.unmatch:hover {
      background: #e74c3c;
      color: white;
    }

    /* Collapsible */
    .collapsible-content {
      display: none;
    }

    .collapsible-content.show {
      display: block;
    }

    .toggle-icon {
      transition: transform 0.3s;
    }

    .toggle-icon.rotated {
      transform: rotate(90deg);
    }

    /* Forms */
    input[type="file"] {
      padding: 10px;
      border: 2px dashed #3498db;
      border-radius: 6px;
      width: 100%;
      margin-bottom: 15px;
      cursor: pointer;
      background: #f8f9fa;
    }

    textarea {
      width: 100%;
      height: 200px;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
      transition: border-color 0.3s;
      margin-bottom: 15px;
    }

    textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    /* Buttons */
    button {
      padding: 10px 20px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button:hover {
      background: #2980b9;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }

    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #95a5a6;
    }

    .btn-secondary:hover {
      background: #7f8c8d;
    }

    .btn-success {
      background: #27ae60;
    }

    .btn-success:hover {
      background: #229954;
    }

    /* Status Messages */
    .status {
      margin-top: 15px;
      padding: 12px 20px;
      border-radius: 6px;
      font-weight: 500;
      display: none;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }

    /* Loading Spinner */
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    .stat-card.purple {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
    }

    .stat-card.orange {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }

    .stat-card.red {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .stat-card.green {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    }

    .stat-card h3 {
      font-size: 2rem;
      margin-bottom: 5px;
    }

    .stat-card p {
      opacity: 0.9;
      font-size: 0.9rem;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal-content {
      background: white;
      max-width: 800px;
      margin: 50px auto;
      padding: 30px;
      border-radius: 12px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
    }

    .modal-close {
      font-size: 28px;
      cursor: pointer;
      color: #666;
      line-height: 1;
    }

    .modal-close:hover {
      color: #333;
    }

    /* Duplicate Management Modal */
    .duplicate-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .duplicate-item {
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 10px;
      background: #f8f9fa;
    }

    .duplicate-item.selected {
      background: #e3f2fd;
      border-color: #3498db;
    }

    .duplicate-actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.5rem;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .staff-item {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .filter-row {
        flex-direction: column;
      }
      
      .filter-group {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>üìã CEDD Staff Management System</h1>
      <p>Engineers and Management Directory</p>
    </div>
  </div>

  <div class="container">
    <!-- Statistics Dashboard -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card purple">
        <h3 id="totalEngineers">0</h3>
        <p>Total Engineers</p>
      </div>
      <div class="stat-card orange">
        <h3 id="totalDirectors">0</h3>
        <p>Directors</p>
      </div>
      <div class="stat-card red">
        <h3 id="totalChiefs">0</h3>
        <p>Chiefs/Heads</p>
      </div>
      <div class="stat-card green">
        <h3 id="totalWithPostings">0</h3>
        <p>With Postings</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-button active" onclick="switchTab('staff')">Staff Directory</button>
      <button class="tab-button" onclick="switchTab('upload')">Upload Data</button>
      <button class="tab-button" onclick="switchTab('postings')">Posting Notices</button>
      <button class="tab-button" onclick="switchTab('duplicates')">Manage Duplicates</button>
    </div>

    <!-- Staff List Tab -->
    <div id="staffTab" class="tab-content active">
      <div class="card">
        <h2>üë∑ Engineers & Management Directory</h2>
        
        <!-- Filter Section -->
        <div class="filter-section">
          <!-- Rank Filters -->
          <div class="filter-group">
            <label>Filter by Rank Categories:</label>
            <div class="rank-filters" id="rankFilters">
              <button class="rank-filter-btn engineer" onclick="toggleRankFilter('engineer')">Engineers</button>
              <button class="rank-filter-btn director" onclick="toggleRankFilter('director')">Directors</button>
              <button class="rank-filter-btn chief" onclick="toggleRankFilter('chief')">Chiefs/Heads</button>
              <button class="rank-filter-btn" onclick="toggleRankFilter('all')">Show All</button>
            </div>
          </div>
          
          <!-- Department and Office Filters -->
          <div class="filter-row">
            <div class="filter-group">
              <label for="departmentFilter">Department:</label>
              <select id="departmentFilter" onchange="applyFilters()">
                <option value="">All Departments</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label for="officeFilter">Office:</label>
              <select id="officeFilter" onchange="applyFilters()">
                <option value="">All Offices</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>&nbsp;</label>
              <button onclick="resetFilters()" class="btn-secondary">Reset Filters</button>
            </div>
          </div>
        </div>

        <!-- Grouped Staff List -->
        <div id="groupedStaffList"></div>
      </div>
    </div>

    <!-- Upload Tab -->
    <div id="uploadTab" class="tab-content">
      <div class="card">
        <h2>üì§ Upload Staff Data (CSV)</h2>
        
        <input type="file" id="csvFile" accept=".csv">
        <button onclick="uploadCSV()">üì§ Upload Staff CSV</button>
        <button class="btn-secondary" onclick="clearStaffData()">üóëÔ∏è Clear All Staff Data</button>
        
        <div id="csvStatus" class="status"></div>
      </div>

      <div class="card">
        <h2>üìã Upload Posting Notices (JSON)</h2>
        
        <textarea id="jsonInput" placeholder='Paste posting notices in JSON format...'></textarea>
        <button onclick="uploadPostings()">üì§ Upload Postings</button>
        <button class="btn-secondary" onclick="clearPostingsInput()">üóëÔ∏è Clear Input</button>
        
        <div id="postingStatus" class="status"></div>
      </div>
    </div>

    <!-- Postings Tab -->
    <div id="postingsTab" class="tab-content">
      <div class="card">
        <h2>üìã Recent Posting Notices</h2>
        
        <div id="postingsContent"></div>
      </div>
    </div>

    <!-- Duplicates Tab -->
    <div id="duplicatesTab" class="tab-content">
      <div class="card">
        <h2>üë• Manage Duplicate Names</h2>
        
        <div id="duplicatesContent"></div>
      </div>
    </div>
  </div>

  <!-- Staff Detail Modal -->
  <div id="staffModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Staff Details</h2>
        <span class="modal-close" onclick="closeModal()">&times;</span>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Duplicate Match Modal -->
  <div id="duplicateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Match/Unmatch Duplicate Names</h2>
        <span class="modal-close" onclick="closeDuplicateModal()">&times;</span>
      </div>
      <div id="duplicateModalBody"></div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDc0NVogv24jSepYYKS1Dbw3Y32IlRBJ_A",
      authDomain: "posting-notice.firebaseapp.com",
      projectId: "posting-notice",
      storageBucket: "posting-notice.firebasestorage.app",
      messagingSenderId: "245130394809",
      appId: "1:245130394809:web:c428677d6cc884ef0eaf68",
      measurementId: "G-TY0K1VQPX5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global variables
    let allStaff = [];
    let filteredStaff = [];
    let allPostings = [];
    let staffPostingsMap = new Map();
    let duplicateGroups = new Map(); // Groups of potentially duplicate names
    let manualMatches = new Map(); // Manual matches/unmatches
    let activeRankFilters = new Set();
    let collapsedDepartments = new Set();
    let collapsedOffices = new Set();

    // Rank hierarchy for sorting
    const rankHierarchy = {
      // Directors
      'Director': 100, 'Dir': 100, 'D': 100,
      'Deputy Director': 95, 'Dep Dir': 95, 'DD': 95,
      'Assistant Director': 90, 'Asst Dir': 90, 'AD': 90,
      
      // Chiefs and Heads
      'Head': 85, 'Dep Head': 83,
      'Chief': 80, 'Ch': 80,
      'Project Manager': 78, 'PM': 78,
      'Project Team Leader': 76,
      'Principal': 75, 'Prin': 75,
      
      // Engineers
      'Chief Engineer': 70, 'CE': 70, 'Ch Engr': 70,
      'Senior Engineer': 65, 'SE': 65, 'Sr Engr': 65,
      'Engineer': 60, 'E': 60, 'Engr': 60,
      'Assistant Engineer': 55, 'AE': 55, 'Asst Engr': 55,
      
      // Geo Engineers
      'Chief Geotechnical Engineer': 70, 'Ch Geo Engr': 70,
      'Senior Geotechnical Engineer': 65, 'Sr Geo Engr': 65,
      'Geotechnical Engineer': 60, 'Geo Engr': 60,
      'Assistant Geotechnical Engineer': 55, 'Asst Geo Engr': 55,
      
      // Other positions
      'Manager': 50,
      'Secretary': 45,
      'Officer': 40
    };

    // Define patterns for categorization
    const engineerPatterns = [
      /^Chief Engineer/i, /^CE\b/i, /^Ch\s*Engr/i,
      /^Senior Engineer/i, /^SE\b/i, /^Sr\s*Engr/i,
      /^Engineer(?!\s*Specialist)/i, /^E\b/i, /^Engr\b/i,
      /^Assistant Engineer/i, /^AE\b/i, /^Asst\s*Engr/i,
      /Geo(?:technical)?\s*Engr/i, /^Sr\s*Geo\s*Engr/i,
      /^Ch\s*Geo\s*Engr/i, /^Asst\s*Geo\s*Engr/i
    ];

    const directorPatterns = [
      /^Director/i, /^Dir\b/i, /^D\b/i,
      /^Deputy Director/i, /^Dep\s*Dir/i, /^DD\b/i,
      /^Assistant Director/i, /^Asst\s*Dir/i, /^AD\b/i
    ];

    const managementPatterns = [
      /^Head\s+of/i, /^Dep\s*Head/i,
      /^Chief/i, /^Ch\b/i,
      /^Principal/i, /^Prin\b/i,
      /Project\s*Manager/i, /^PM\b/i,
      /Project\s*Team\s*Leader/i,
      /Commissioner/i, /Comr\./i,
      /Secretary/i,
      /Manager/i
    ];

    // Initialize app
    document.addEventListener('DOMContentLoaded', async () => {
      await loadAllData();
    });

    // Remove title from name for display
    function removeTitle(name) {
      if (!name) return '';
      
      const titles = ['Mr\\.?', 'Ms\\.?', 'Miss\\.?', 'Mrs\\.?', 'Dr\\.?', 'Prof\\.?'];
      let cleanName = name;
      
      titles.forEach(title => {
        const regex = new RegExp(`^${title}\\s+`, 'i');
        cleanName = cleanName.replace(regex, '');
      });
      
      return cleanName.trim();
    }

    // Normalize name for matching
    function normalizeName(name) {
      if (!name) return '';
      
      let normalized = removeTitle(name).toUpperCase();
      normalized = normalized
        .replace(/\s+/g, ' ')
        .replace(/\s*-\s*/g, '-')
        .trim();
      
      const coreParts = normalized.split(',');
      if (coreParts.length > 0) {
        normalized = coreParts[0].trim();
      }
      
      return normalized;
    }

    // Get rank score for sorting
    function getRankScore(postTitle) {
      if (!postTitle) return 0;
      
      // Check exact matches first
      for (let [pattern, score] of Object.entries(rankHierarchy)) {
        if (postTitle.toLowerCase().includes(pattern.toLowerCase())) {
          return score;
        }
      }
      
      // Check patterns
      if (engineerPatterns.some(p => p.test(postTitle))) return 50;
      if (directorPatterns.some(p => p.test(postTitle))) return 85;
      if (managementPatterns.some(p => p.test(postTitle))) return 70;
      
      return 0;
    }

    // Check if position matches filters
    function isEngineerOrManagement(postTitle) {
      if (!postTitle) return false;
      
      for (let pattern of [...engineerPatterns, ...directorPatterns, ...managementPatterns]) {
        if (pattern.test(postTitle)) return true;
      }
      
      return false;
    }

    // Get rank category
    function getRankCategory(postTitle) {
      if (!postTitle) return null;
      
      for (let pattern of engineerPatterns) {
        if (pattern.test(postTitle)) return 'engineer';
      }
      
      for (let pattern of directorPatterns) {
        if (pattern.test(postTitle)) return 'director';
      }
      
      for (let pattern of managementPatterns) {
        if (pattern.test(postTitle)) return 'chief';
      }
      
      return null;
    }

    // Find duplicate groups
    function findDuplicateGroups() {
      duplicateGroups.clear();
      const nameMap = new Map();
      
      // Group by similar names
      allStaff.forEach(staff => {
        const normalized = normalizeName(staff.fullName);
        const baseKey = normalized.split(/[\s-]+/).slice(0, 2).join(' ');
        
        if (!nameMap.has(baseKey)) {
          nameMap.set(baseKey, []);
        }
        nameMap.get(baseKey).push(staff);
      });
      
      // Keep only groups with multiple people
      nameMap.forEach((group, key) => {
        if (group.length > 1) {
          duplicateGroups.set(key, group);
        }
      });
    }

    // Load manual matches from localStorage
    function loadManualMatches() {
      const saved = localStorage.getItem('cedd_manual_matches');
      if (saved) {
        try {
          const matches = JSON.parse(saved);
          manualMatches = new Map(matches);
        } catch (e) {
          manualMatches = new Map();
        }
      }
    }

    // Save manual matches to localStorage
    function saveManualMatches() {
      localStorage.setItem('cedd_manual_matches', JSON.stringify([...manualMatches]));
    }

    // Toggle rank filter
    function toggleRankFilter(category) {
      if (category === 'all') {
        activeRankFilters.clear();
      } else {
        if (activeRankFilters.has(category)) {
          activeRankFilters.delete(category);
        } else {
          activeRankFilters.add(category);
        }
      }
      
      // Update button states
      updateRankFilterButtons();
      applyFilters();
    }

    // Update rank filter button states
    function updateRankFilterButtons() {
      const buttons = document.querySelectorAll('.rank-filter-btn');
      buttons.forEach(btn => {
        const category = btn.textContent.toLowerCase();
        if (category === 'show all') {
          btn.classList.toggle('active', activeRankFilters.size === 0);
        } else if (category === 'engineers') {
          btn.classList.toggle('active', activeRankFilters.has('engineer'));
        } else if (category === 'directors') {
          btn.classList.toggle('active', activeRankFilters.has('director'));
        } else if (category === 'chiefs/heads') {
          btn.classList.toggle('active', activeRankFilters.has('chief'));
        }
      });
    }

    // Apply filters
    function applyFilters() {
      const department = document.getElementById('departmentFilter').value;
      const office = document.getElementById('officeFilter').value;
      
      filteredStaff = allStaff.filter(staff => {
        // First filter by engineer/management
        if (!isEngineerOrManagement(staff.postTitle)) return false;
        
        // Apply rank category filter
        if (activeRankFilters.size > 0) {
          const category = getRankCategory(staff.postTitle);
          if (!category || !activeRankFilters.has(category)) return false;
        }
        
        // Apply department filter
        if (department && staff.department !== department) return false;
        
        // Apply office filter
        if (office && staff.office !== office) return false;
        
        return true;
      });
      
      displayGroupedStaff();
    }

    // Reset filters
    function resetFilters() {
      document.getElementById('departmentFilter').value = '';
      document.getElementById('officeFilter').value = '';
      activeRankFilters.clear();
      updateRankFilterButtons();
      applyFilters();
    }

    // Toggle department collapse
    function toggleDepartment(dept) {
      if (collapsedDepartments.has(dept)) {
        collapsedDepartments.delete(dept);
      } else {
        collapsedDepartments.add(dept);
      }
      displayGroupedStaff();
    }

    // Toggle office collapse
    function toggleOffice(key) {
      if (collapsedOffices.has(key)) {
        collapsedOffices.delete(key);
      } else {
        collapsedOffices.add(key);
      }
      displayGroupedStaff();
    }

    // Display grouped staff
    function displayGroupedStaff() {
      const container = document.getElementById('groupedStaffList');
      
      // Group by department and office
      const departmentGroups = new Map();
      
      filteredStaff.forEach(staff => {
        const dept = staff.department || 'Unknown Department';
        if (!departmentGroups.has(dept)) {
          departmentGroups.set(dept, new Map());
        }
        
        const officeMap = departmentGroups.get(dept);
        const office = staff.office || 'No Office';
        
        if (!officeMap.has(office)) {
          officeMap.set(office, []);
        }
        
        officeMap.get(office).push(staff);
      });
      
      // Sort departments
      const sortedDepts = Array.from(departmentGroups.keys()).sort();
      
      let html = '';
      let globalIndex = 1;
      
      sortedDepts.forEach(dept => {
        const officeMap = departmentGroups.get(dept);
        const deptStaffCount = Array.from(officeMap.values()).reduce((sum, staff) => sum + staff.length, 0);
        const isCollapsed = collapsedDepartments.has(dept);
        
        html += `
          <div class="department-group">
            <div class="department-header" onclick="toggleDepartment('${dept}')">
              <span>
                <span class="toggle-icon ${isCollapsed ? '' : 'rotated'}">‚ñ∂</span>
                ${dept}
              </span>
              <span class="department-count">${deptStaffCount} staff</span>
            </div>
            <div class="collapsible-content ${isCollapsed ? '' : 'show'}">
        `;
        
        // Sort offices
        const sortedOffices = Array.from(officeMap.keys()).sort();
        
        sortedOffices.forEach(office => {
          const officeStaff = officeMap.get(office);
          const officeKey = `${dept}|${office}`;
          const isOfficeCollapsed = collapsedOffices.has(officeKey);
          
          // Sort staff by rank score (highest first)
          officeStaff.sort((a, b) => {
            const scoreA = getRankScore(a.postTitle);
            const scoreB = getRankScore(b.postTitle);
            return scoreB - scoreA;
          });
          
          html += `
            <div class="office-group">
              <div class="office-header" onclick="toggleOffice('${officeKey}')">
                <span>
                  <span class="toggle-icon ${isOfficeCollapsed ? '' : 'rotated'}">‚ñ∂</span>
                  ${office}
                </span>
                <span class="office-count">${officeStaff.length}</span>
              </div>
              <div class="staff-list collapsible-content ${isOfficeCollapsed ? '' : 'show'}">
          `;
          
          officeStaff.forEach(staff => {
            const displayName = staff.displayName || removeTitle(staff.fullName);
            const postings = staffPostingsMap.get(staff.id) || [];
            const category = getRankCategory(staff.postTitle);
            
            let rankBadge = '';
            if (category === 'engineer') {
              rankBadge = '<span class="rank-badge engineer-badge">ENG</span>';
            } else if (category === 'director') {
              rankBadge = '<span class="rank-badge director-badge">DIR</span>';
            } else if (category === 'chief') {
              rankBadge = '<span class="rank-badge chief-badge">CHIEF</span>';
            }
            
            // Check for duplicates
            const normalized = normalizeName(staff.fullName);
            const isDuplicate = Array.from(duplicateGroups.values()).some(group => 
              group.some(s => s.id === staff.id && group.length > 1)
            );
            
            html += `
              <div class="staff-item" onclick="viewStaffDetails('${staff.id}')">
                <div class="staff-number">${globalIndex++}</div>
                <div class="staff-name">
                  ${displayName}
                  ${rankBadge}
                  ${isDuplicate ? '<span class="duplicate-indicator">DUP</span>' : ''}
                </div>
                <div class="staff-title">${staff.postTitle}</div>
                <div class="staff-tel">${staff.officeTel || '-'}</div>
                <div class="staff-postings">
                  ${postings.length > 0 ? 
                    `<span class="posting-match">${postings.length}</span>` : 
                    '-'
                  }
                </div>
                <div class="staff-actions" onclick="event.stopPropagation()">
                  ${isDuplicate ? 
                    `<button class="action-btn match" onclick="manageDuplicate('${staff.id}')">Manage</button>` : 
                    ''
                  }
                </div>
              </div>
            `;
          });
          
          html += '</div></div>';
        });
        
        html += '</div></div>';
      });
      
      if (filteredStaff.length === 0) {
        html = '<div style="text-align: center; padding: 40px; color: #666;">No staff found matching the selected filters.</div>';
      }
      
      container.innerHTML = html;
    }

    // Manage duplicate
    function manageDuplicate(staffId) {
      const staff = allStaff.find(s => s.id === staffId);
      if (!staff) return;
      
      const normalized = normalizeName(staff.fullName);
      let duplicateGroup = null;
      
      // Find the duplicate group
      duplicateGroups.forEach((group, key) => {
        if (group.some(s => s.id === staffId)) {
          duplicateGroup = group;
        }
      });
      
      if (!duplicateGroup) return;
      
      const modal = document.getElementById('duplicateModal');
      const modalBody = document.getElementById('duplicateModalBody');
      
      let html = `
        <h3>Potential Duplicates for: ${removeTitle(staff.fullName)}</h3>
        <p style="color: #666; margin-bottom: 20px;">Select staff members that are the same person:</p>
        
        <div class="duplicate-list">
      `;
      
      duplicateGroup.forEach(s => {
        const isSelected = manualMatches.get(s.id) === staff.id || s.id === staff.id;
        
        html += `
          <div class="duplicate-item ${isSelected ? 'selected' : ''}" onclick="toggleDuplicateSelection('${s.id}', '${staff.id}')">
            <div><strong>${removeTitle(s.fullName)}</strong></div>
            <div style="color: #666; font-size: 14px;">${s.postTitle}</div>
            <div style="color: #666; font-size: 14px;">${s.department} - ${s.office || 'No Office'}</div>
            <div style="color: #666; font-size: 14px;">Tel: ${s.officeTel || 'N/A'}</div>
          </div>
        `;
      });
      
      html += `
        </div>
        
        <div class="duplicate-actions">
          <button class="btn-success" onclick="saveDuplicateMatches('${staff.id}')">Save Matches</button>
          <button class="btn-secondary" onclick="closeDuplicateModal()">Cancel</button>
        </div>
      `;
      
      modalBody.innerHTML = html;
      modal.style.display = 'block';
    }

    // Toggle duplicate selection
    function toggleDuplicateSelection(targetId, baseId) {
      const items = document.querySelectorAll('.duplicate-item');
      items.forEach(item => {
        if (item.textContent.includes(targetId)) {
          item.classList.toggle('selected');
        }
      });
    }

    // Save duplicate matches
    function saveDuplicateMatches(baseId) {
      const selected = document.querySelectorAll('.duplicate-item.selected');
      
      // Clear previous matches for this group
      const staff = allStaff.find(s => s.id === baseId);
      const normalized = normalizeName(staff.fullName);
      
      duplicateGroups.forEach((group) => {
        group.forEach(s => {
          if (manualMatches.get(s.id) === baseId) {
            manualMatches.delete(s.id);
          }
        });
      });
      
      // Set new matches
      selected.forEach(item => {
        const staffInfo = item.textContent;
        const matchedStaff = allStaff.find(s => 
          staffInfo.includes(removeTitle(s.fullName)) && 
          staffInfo.includes(s.postTitle)
        );
        
        if (matchedStaff && matchedStaff.id !== baseId) {
          manualMatches.set(matchedStaff.id, baseId);
        }
      });
      
      saveManualMatches();
      closeDuplicateModal();
      
      // Refresh display
      matchStaffWithPostings();
      updateStatistics();
      displayGroupedStaff();
      
      showStatus(document.getElementById('csvStatus'), 'success', '‚úÖ Duplicate matches saved successfully');
    }

    // Display duplicates management page
    function displayDuplicatesManagement() {
      const container = document.getElementById('duplicatesContent');
      
      if (duplicateGroups.size === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No duplicate names found.</p>';
        return;
      }
      
      let html = '<div style="margin-bottom: 20px;">';
      html += `<p>Found ${duplicateGroups.size} groups of potential duplicate names. Click on a group to manage matches.</p>`;
      html += '</div>';
      
      duplicateGroups.forEach((group, key) => {
        html += `
          <div class="department-group" style="margin-bottom: 20px;">
            <div class="office-header" style="cursor: pointer;" onclick="expandDuplicateGroup('${key}')">
              <span>Potential Duplicates: ${key}</span>
              <span class="office-count">${group.length} people</span>
            </div>
            <div id="dupGroup_${key}" style="display: none; padding: 15px;">
        `;
        
        group.forEach(staff => {
          const mainId = manualMatches.get(staff.id);
          const isLinked = mainId && mainId !== staff.id;
          
          html += `
            <div style="padding: 10px; border-bottom: 1px solid #e0e0e0;">
              <div><strong>${removeTitle(staff.fullName)}</strong> ${isLinked ? '(Linked)' : ''}</div>
              <div style="color: #666; font-size: 14px;">${staff.postTitle}</div>
              <div style="color: #666; font-size: 14px;">${staff.department} - ${staff.office || 'No Office'}</div>
              <button class="action-btn match" onclick="manageDuplicate('${staff.id}')" style="margin-top: 5px;">
                Manage Matches
              </button>
            </div>
          `;
        });
        
        html += '</div></div>';
      });
      
      container.innerHTML = html;
    }

    // Expand duplicate group
    function expandDuplicateGroup(key) {
      const element = document.getElementById(`dupGroup_${key}`);
      if (element) {
        element.style.display = element.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Load all data
    async function loadAllData() {
      await loadStaffData();
      await loadPostingsData();
      loadManualMatches();
      findDuplicateGroups();
      matchStaffWithPostings();
      updateStatistics();
      populateFilters();
      applyFilters();
    }

    // Load staff data
    async function loadStaffData() {
      try {
        const snapshot = await db.collection('staff').get();
        allStaff = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          allStaff.push({ 
            id: doc.id, 
            ...data,
            displayName: removeTitle(data.fullName)
          });
        });
        
      } catch (error) {
        console.error('Error loading staff data:', error);
      }
    }

    // Load postings data
    async function loadPostingsData() {
      try {
        const snapshot = await db.collection('postings').get();
        allPostings = [];
        
        snapshot.forEach(doc => {
          allPostings.push({ id: doc.id, ...doc.data() });
        });
        
        allPostings.sort((a, b) => (b.dateFrom || '').localeCompare(a.dateFrom || ''));
        
      } catch (error) {
        console.error('Error loading postings data:', error);
      }
    }

    // Match staff with postings
    function matchStaffWithPostings() {
      staffPostingsMap.clear();
      
      // Consider manual matches
      allPostings.forEach(posting => {
        let matched = false;
        
        allStaff.forEach(staff => {
          const staffNormalized = normalizeName(staff.fullName);
          const postingNormalized = normalizeName(posting.name);
          
          // Check direct match
          if (staffNormalized === postingNormalized) {
            if (!staffPostingsMap.has(staff.id)) {
              staffPostingsMap.set(staff.id, []);
            }
            staffPostingsMap.get(staff.id).push(posting);
            matched = true;
          }
          
          // Check manual match
          const mainId = manualMatches.get(staff.id);
          if (mainId) {
            const mainStaff = allStaff.find(s => s.id === mainId);
            if (mainStaff && normalizeName(mainStaff.fullName) === postingNormalized) {
              if (!staffPostingsMap.has(staff.id)) {
                staffPostingsMap.set(staff.id, []);
              }
              staffPostingsMap.get(staff.id).push(posting);
              matched = true;
            }
          }
        });
      });
    }

    // Populate filter dropdowns
    function populateFilters() {
      // Populate departments
      const departments = new Set();
      const offices = new Set();
      
      allStaff.forEach(staff => {
        if (staff.department) departments.add(staff.department);
        if (staff.office) offices.add(staff.office);
      });
      
      const deptSelect = document.getElementById('departmentFilter');
      deptSelect.innerHTML = '<option value="">All Departments</option>';
      Array.from(departments).sort().forEach(dept => {
        deptSelect.innerHTML += `<option value="${dept}">${dept}</option>`;
      });
      
      const officeSelect = document.getElementById('officeFilter');
      officeSelect.innerHTML = '<option value="">All Offices</option>';
      Array.from(offices).sort().forEach(office => {
        officeSelect.innerHTML += `<option value="${office}">${office}</option>`;
      });
    }

    // Update statistics
    function updateStatistics() {
      let engineerCount = 0;
      let directorCount = 0;
      let chiefCount = 0;
      let withPostingsCount = 0;
      
      allStaff.forEach(staff => {
        if (!isEngineerOrManagement(staff.postTitle)) return;
        
        const category = getRankCategory(staff.postTitle);
        if (category === 'engineer') engineerCount++;
        else if (category === 'director') directorCount++;
        else if (category === 'chief') chiefCount++;
        
        if (staffPostingsMap.has(staff.id)) {
          withPostingsCount++;
        }
      });
      
      document.getElementById('totalEngineers').textContent = engineerCount;
      document.getElementById('totalDirectors').textContent = directorCount;
      document.getElementById('totalChiefs').textContent = chiefCount;
      document.getElementById('totalWithPostings').textContent = withPostingsCount;
    }

    // View staff details
    function viewStaffDetails(staffId) {
      const staff = allStaff.find(s => s.id === staffId);
      if (!staff) return;
      
      const postings = staffPostingsMap.get(staffId) || [];
      const modal = document.getElementById('staffModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      
      modalTitle.textContent = `Staff Details: ${removeTitle(staff.fullName)}`;
      
      let html = `
        <div style="margin-bottom: 20px;">
          <h3 style="color: #2c3e50; margin-bottom: 15px;">Basic Information</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            <div>
              <strong>Full Name:</strong> ${staff.fullName}
            </div>
            <div>
              <strong>Display Name:</strong> ${removeTitle(staff.fullName)}
            </div>
            <div>
              <strong>Post Title:</strong> ${staff.postTitle}
            </div>
            <div>
              <strong>Department:</strong> ${staff.department}
            </div>
            <div>
              <strong>Office:</strong> ${staff.office || 'N/A'}
            </div>
            <div>
              <strong>Office Tel:</strong> ${staff.officeTel || 'N/A'}
            </div>
          </div>
        </div>
      `;
      
      if (postings.length > 0) {
        html += `
          <div>
            <h3 style="color: #2c3e50; margin-bottom: 15px;">Posting History (${postings.length})</h3>
            <table style="width: 100%; font-size: 14px;">
              <thead>
                <tr>
                  <th style="background: #3498db; color: white; padding: 8px;">Date</th>
                  <th style="background: #3498db; color: white; padding: 8px;">From</th>
                  <th style="background: #3498db; color: white; padding: 8px;">To</th>
                  <th style="background: #3498db; color: white; padding: 8px;">Notice ID</th>
                  <th style="background: #3498db; color: white; padding: 8px;">Remarks</th>
                </tr>
              </thead>
              <tbody>
                ${postings.map(p => `
                  <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${p.dateFrom || 'N/A'}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${p.from || 'N/A'}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${p.to || 'N/A'}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${p.noticeId || 'N/A'}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${p.remarks || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } else {
        html += '<p style="color: #666;">No posting notices found for this staff member.</p>';
      }
      
      modalBody.innerHTML = html;
      modal.style.display = 'block';
    }

    // Close modals
    function closeModal() {
      document.getElementById('staffModal').style.display = 'none';
    }

    function closeDuplicateModal() {
      document.getElementById('duplicateModal').style.display = 'none';
    }

    // Switch tabs
    function switchTab(tabName) {
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      if (tabName === 'duplicates') {
        displayDuplicatesManagement();
      }
    }

    // Parse CSV
    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      const headers = parseCSVLine(lines[0]);
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((header, index) => {
          row[header.trim()] = values[index] ? values[index].trim() : '';
        });
        data.push(row);
      }
      
      return data;
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      let i = 0;
      
      while (i < line.length) {
        const char = line[i];
        
        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
        
        i++;
      }
      
      result.push(current);
      return result;
    }

    // Upload CSV
    async function uploadCSV() {
      const fileInput = document.getElementById('csvFile');
      const status = document.getElementById('csvStatus');
      
      if (!fileInput.files.length) {
        showStatus(status, 'error', '‚ùå Please select a CSV file');
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      status.innerHTML = '<span class="loader"></span> Processing CSV file...';
      status.className = 'status info';
      
      reader.onload = async (e) => {
        try {
          const csvData = parseCSV(e.target.result);
          
          if (!csvData.length) {
            throw new Error('No data found in CSV file');
          }
          
          const staffData = csvData.map(row => ({
            department: row['Department'] || '',
            office: row['Office'] || '',
            fullName: row['Full Name'] || '',
            postTitle: row['Post Title'] || '',
            officeTel: row['Office Tel'] || '',
            normalizedName: normalizeName(row['Full Name'] || ''),
            displayName: removeTitle(row['Full Name'] || ''),
            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
          }));
          
          const validStaffData = staffData.filter(staff => 
            staff.fullName && staff.department
          );
          
          if (validStaffData.length === 0) {
            throw new Error('No valid staff data found');
          }
          
          const batch = db.batch();
          validStaffData.forEach(staff => {
            const docRef = db.collection('staff').doc();
            batch.set(docRef, staff);
          });
          
          await batch.commit();
          
          showStatus(status, 'success', `‚úÖ Successfully uploaded ${validStaffData.length} staff records`);
          fileInput.value = '';
          
          await loadAllData();
          
        } catch (error) {
          showStatus(status, 'error', `‚ùå Error: ${error.message}`);
        }
      };
      
      reader.readAsText(file);
    }

    // Upload postings
    async function uploadPostings() {
      const input = document.getElementById('jsonInput').value;
      const status = document.getElementById('postingStatus');
      
      if (!input.trim()) {
        showStatus(status, 'error', '‚ùå Please enter JSON data');
        return;
      }
      
      status.innerHTML = '<span class="loader"></span> Uploading postings...';
      status.className = 'status info';
      
      try {
        const data = JSON.parse(input);
        if (!Array.isArray(data)) {
          throw new Error('Data must be a JSON array');
        }
        
        const batch = db.batch();
        data.forEach(posting => {
          const docRef = db.collection('postings').doc();
          batch.set(docRef, {
            ...posting,
            normalizedName: normalizeName(posting.name || ''),
            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        
        await batch.commit();
        
        showStatus(status, 'success', `‚úÖ Successfully uploaded ${data.length} posting notices`);
        document.getElementById('jsonInput').value = '';
        
        await loadAllData();
        
      } catch (error) {
        showStatus(status, 'error', `‚ùå Error: ${error.message}`);
      }
    }

    // Clear staff data
    async function clearStaffData() {
      if (!confirm('Are you sure you want to delete all staff data?')) return;
      
      const status = document.getElementById('csvStatus');
      status.innerHTML = '<span class="loader"></span> Clearing staff data...';
      status.className = 'status info';
      
      try {
        const snapshot = await db.collection('staff').get();
        const batch = db.batch();
        
        snapshot.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        showStatus(status, 'success', '‚úÖ All staff data cleared');
        await loadAllData();
        
      } catch (error) {
        showStatus(status, 'error', `‚ùå Error: ${error.message}`);
      }
    }

    // Clear postings input
    function clearPostingsInput() {
      document.getElementById('jsonInput').value = '';
    }

    // Show status
    function showStatus(element, type, message) {
      element.textContent = message;
      element.className = `status ${type}`;
      
      setTimeout(() => {
        element.className = 'status';
      }, 5000);
    }

    // Close modal on outside click
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }
  </script>
</body>
</html>