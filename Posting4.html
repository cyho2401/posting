<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CEDD Staff Management System</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f6fa;
      color: #333;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white;
      padding: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .header h1 {
      font-size: 2.2rem;
      margin-bottom: 5px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1rem;
    }

    /* Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Cards */
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .card h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }

    .tab-button {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .tab-button:hover {
      color: #3498db;
    }

    .tab-button.active {
      color: #3498db;
      border-bottom-color: #3498db;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Forms */
    .upload-section {
      margin-bottom: 20px;
    }

    .upload-section h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    input[type="file"] {
      padding: 10px;
      border: 2px dashed #3498db;
      border-radius: 6px;
      width: 100%;
      margin-bottom: 15px;
      cursor: pointer;
      background: #f8f9fa;
    }

    textarea {
      width: 100%;
      height: 200px;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
      transition: border-color 0.3s;
      margin-bottom: 15px;
    }

    textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    /* Buttons */
    button {
      padding: 10px 20px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button:hover {
      background: #2980b9;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }

    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #95a5a6;
    }

    .btn-secondary:hover {
      background: #7f8c8d;
    }

    .btn-success {
      background: #27ae60;
    }

    .btn-success:hover {
      background: #229954;
    }

    /* Search Bar */
    .search-container {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1;
      min-width: 300px;
      padding: 12px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .filter-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
    }

    .filter-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th {
      background: #34495e;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    tr:hover {
      background: #f8f9fa;
    }

    tr:nth-child(even) {
      background: #fafbfc;
    }

    /* Posting Badge */
    .posting-badge {
      background: #e74c3c;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .posting-match {
      background: #27ae60;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 16px;
      min-width: 40px;
    }

    .pagination span {
      color: #666;
      font-size: 14px;
    }

    /* Status Messages */
    .status {
      margin-top: 15px;
      padding: 12px 20px;
      border-radius: 6px;
      font-weight: 500;
      display: none;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }

    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
      display: block;
    }

    /* Loading Spinner */
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    .stat-card.purple {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
    }

    .stat-card.green {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    }

    .stat-card.orange {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }

    .stat-card.red {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .stat-card h3 {
      font-size: 2rem;
      margin-bottom: 5px;
    }

    .stat-card p {
      opacity: 0.9;
      font-size: 0.9rem;
    }

    /* Sample Data */
    .sample-data {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 12px;
      color: #666;
    }

    .sample-data h4 {
      color: #333;
      margin-bottom: 10px;
    }

    .sample-data pre {
      background: white;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* No Results */
    .no-results {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 1.1rem;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal-content {
      background: white;
      max-width: 800px;
      margin: 50px auto;
      padding: 30px;
      border-radius: 12px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
    }

    .modal-close {
      font-size: 28px;
      cursor: pointer;
      color: #666;
      line-height: 1;
    }

    .modal-close:hover {
      color: #333;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.5rem;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>üìã CEDD Staff Management System</h1>
      <p>Manage staff records and posting notices efficiently</p>
    </div>
  </div>

  <div class="container">
    <!-- Statistics Dashboard -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3 id="totalStaff">0</h3>
        <p>Total Staff</p>
      </div>
      <div class="stat-card purple">
        <h3 id="totalDepartments">0</h3>
        <p>Departments</p>
      </div>
      <div class="stat-card green">
        <h3 id="totalOffices">0</h3>
        <p>Offices</p>
      </div>
      <div class="stat-card orange">
        <h3 id="totalPostings">0</h3>
        <p>Posting Notices</p>
      </div>
      <div class="stat-card red">
        <h3 id="staffWithPostings">0</h3>
        <p>Staff with Postings</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-button active" onclick="switchTab('staff')">Staff List</button>
      <button class="tab-button" onclick="switchTab('upload')">Upload Data</button>
      <button class="tab-button" onclick="switchTab('postings')">Posting Notices</button>
    </div>

    <!-- Staff List Tab -->
    <div id="staffTab" class="tab-content active">
      <div class="card">
        <h2>üë• Staff Directory</h2>
        
        <div class="search-container">
          <input 
            type="text" 
            id="searchInput" 
            class="search-input" 
            placeholder="Search by name, rank, or department..." 
            onkeyup="performSearch()"
          >
          <div class="filter-checkbox">
            <input type="checkbox" id="showPostingsOnly" onchange="performSearch()">
            <label for="showPostingsOnly">Show only staff with postings</label>
          </div>
        </div>

        <div class="table-container">
          <table id="staffTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Full Name</th>
                <th>Post Title</th>
                <th>Department</th>
                <th>Office</th>
                <th>Office Tel</th>
                <th>Postings</th>
              </tr>
            </thead>
            <tbody id="staffTableBody">
              <tr>
                <td colspan="7" class="no-results">No staff data available. Please upload staff CSV file.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination" id="pagination">
          <button onclick="previousPage()" id="prevBtn" disabled>Previous</button>
          <span id="pageInfo">Page 1 of 1</span>
          <button onclick="nextPage()" id="nextBtn" disabled>Next</button>
        </div>
      </div>
    </div>

    <!-- Upload Tab -->
    <div id="uploadTab" class="tab-content">
      <div class="card">
        <h2>üì§ Upload Staff Data (CSV)</h2>
        
        <div class="sample-data">
          <h4>Expected CSV Format:</h4>
          <pre>Department,Office,Full Name,Post Title,Office Tel
Civil Engineering and Development Department,,"Mr. FONG Hok Shing, Michael, JP",Dir of Civil Engineering & Dev also Comr. of Mines,2762 5000</pre>
        </div>

        <div class="upload-section">
          <input type="file" id="csvFile" accept=".csv">
          <button onclick="uploadCSV()">üì§ Upload Staff CSV</button>
          <button class="btn-secondary" onclick="clearStaffData()">üóëÔ∏è Clear All Staff Data</button>
        </div>

        <div id="csvStatus" class="status"></div>
      </div>

      <div class="card">
        <h2>üìã Upload Posting Notices (JSON)</h2>
        
        <div class="sample-data">
          <h4>Expected JSON Format:</h4>
          <pre>[
  {
    "name": "Ms LAI Pik-hung",
    "rank": "Senior Town Planner",
    "from": "SSLO",
    "to": "STP",
    "dateFrom": "2025-06-11",
    "dateTo": "",
    "noticeId": "PN-44-2025",
    "noticeType": "Posting Notice",
    "remarks": "On transfer"
  }
]</pre>
        </div>

        <textarea id="jsonInput" placeholder='Paste posting notices in JSON format...'></textarea>
        <div class="button-group">
          <button onclick="uploadPostings()">üì§ Upload Postings</button>
          <button class="btn-secondary" onclick="clearPostingsInput()">üóëÔ∏è Clear Input</button>
        </div>

        <div id="postingStatus" class="status"></div>
      </div>
    </div>

    <!-- Postings Tab -->
    <div id="postingsTab" class="tab-content">
      <div class="card">
        <h2>üìã Recent Posting Notices</h2>
        
        <div class="table-container">
          <table id="postingsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Rank</th>
                <th>From</th>
                <th>To</th>
                <th>Notice ID</th>
                <th>Remarks</th>
                <th>Staff Match</th>
              </tr>
            </thead>
            <tbody id="postingsTableBody">
              <tr>
                <td colspan="8" class="no-results">No posting notices available.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Staff Detail Modal -->
  <div id="staffModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Staff Details</h2>
        <span class="modal-close" onclick="closeModal()">&times;</span>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    // Firebase configuration (same as in Posting2.html)
    const firebaseConfig = {
      apiKey: "AIzaSyDc0NVogv24jSepYYKS1Dbw3Y32IlRBJ_A",
      authDomain: "posting-notice.firebaseapp.com",
      projectId: "posting-notice",
      storageBucket: "posting-notice.firebasestorage.app",
      messagingSenderId: "245130394809",
      appId: "1:245130394809:web:c428677d6cc884ef0eaf68",
      measurementId: "G-TY0K1VQPX5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global variables
    let allStaff = [];
    let filteredStaff = [];
    let allPostings = [];
    let staffPostingsMap = new Map(); // Map to store staff->postings relationships
    let currentPage = 1;
    const rowsPerPage = 50;

    // Initialize app
    document.addEventListener('DOMContentLoaded', async () => {
      await loadAllData();
    });

    // Normalize name for matching
    function normalizeName(name) {
      if (!name) return '';
      
      // Remove titles (Mr., Ms., Miss, Mrs., Dr., Prof.)
      const titles = ['Mr\\.?', 'Ms\\.?', 'Miss\\.?', 'Mrs\\.?', 'Dr\\.?', 'Prof\\.?'];
      let normalized = name;
      
      titles.forEach(title => {
        const regex = new RegExp(`^${title}\\s+`, 'i');
        normalized = normalized.replace(regex, '');
      });
      
      // Convert to uppercase for comparison
      normalized = normalized.toUpperCase();
      
      // Remove extra spaces and normalize spaces/hyphens
      normalized = normalized
        .replace(/\s+/g, ' ') // Replace multiple spaces with single space
        .replace(/\s*-\s*/g, '-') // Normalize hyphens
        .trim();
      
      // Extract core name (remove titles like JP, BBS, etc.)
      const coreParts = normalized.split(',');
      if (coreParts.length > 0) {
        normalized = coreParts[0].trim();
      }
      
      return normalized;
    }

    // Create name variations for matching
    function createNameVariations(name) {
      const normalized = normalizeName(name);
      const variations = new Set([normalized]);
      
      // Add variation with spaces replaced by hyphens
      variations.add(normalized.replace(/\s+/g, '-'));
      
      // Add variation with hyphens replaced by spaces
      variations.add(normalized.replace(/-/g, ' '));
      
      // Add variations for Chinese names with two parts
      const parts = normalized.split(/[\s-]+/);
      if (parts.length >= 3) {
        // Try different combinations
        variations.add(`${parts[0]} ${parts.slice(1).join(' ')}`);
        variations.add(`${parts[0]} ${parts.slice(1).join('-')}`);
        variations.add(`${parts[0]}-${parts.slice(1).join('-')}`);
        
        // Also try last two parts combined
        if (parts.length === 3) {
          variations.add(`${parts[0]} ${parts[1]}-${parts[2]}`);
          variations.add(`${parts[0]} ${parts[1]} ${parts[2]}`);
        }
      }
      
      return Array.from(variations);
    }

    // Match staff with postings
    function matchStaffWithPostings() {
      staffPostingsMap.clear();
      
      // Create a map of normalized names to staff
      const staffNameMap = new Map();
      allStaff.forEach(staff => {
        const variations = createNameVariations(staff.fullName);
        variations.forEach(variation => {
          if (!staffNameMap.has(variation)) {
            staffNameMap.set(variation, []);
          }
          staffNameMap.get(variation).push(staff);
        });
      });
      
      // Match postings to staff
      allPostings.forEach(posting => {
        const postingNameVariations = createNameVariations(posting.name);
        
        for (let variation of postingNameVariations) {
          if (staffNameMap.has(variation)) {
            const matchedStaff = staffNameMap.get(variation);
            matchedStaff.forEach(staff => {
              if (!staffPostingsMap.has(staff.id)) {
                staffPostingsMap.set(staff.id, []);
              }
              staffPostingsMap.get(staff.id).push(posting);
            });
            break; // Found a match, no need to check other variations
          }
        }
      });
      
      // Update statistics
      document.getElementById('staffWithPostings').textContent = staffPostingsMap.size;
    }

    // Load all data
    async function loadAllData() {
      await loadStaffData();
      await loadPostingsData();
      matchStaffWithPostings();
      updateStatistics();
    }

    // Load staff data from Firestore
    async function loadStaffData() {
      try {
        const snapshot = await db.collection('staff').get();
        allStaff = [];
        
        snapshot.forEach(doc => {
          allStaff.push({ id: doc.id, ...doc.data() });
        });
        
        filteredStaff = [...allStaff];
        currentPage = 1;
        displayStaff();
        
      } catch (error) {
        console.error('Error loading staff data:', error);
      }
    }

    // Load postings data from Firestore
    async function loadPostingsData() {
      try {
        const snapshot = await db.collection('postings').get();
        allPostings = [];
        
        snapshot.forEach(doc => {
          allPostings.push({ id: doc.id, ...doc.data() });
        });
        
        // Sort by date descending
        allPostings.sort((a, b) => (b.dateFrom || '').localeCompare(a.dateFrom || ''));
        displayPostings();
        
      } catch (error) {
        console.error('Error loading postings data:', error);
      }
    }

    // Update statistics
    function updateStatistics() {
      document.getElementById('totalStaff').textContent = allStaff.length;
      
      // Count unique departments
      const departments = new Set(allStaff.map(s => s.department).filter(d => d));
      document.getElementById('totalDepartments').textContent = departments.size;
      
      // Count unique offices
      const offices = new Set(allStaff.map(s => s.office).filter(o => o));
      document.getElementById('totalOffices').textContent = offices.size;
      
      document.getElementById('totalPostings').textContent = allPostings.length;
    }

    // Parse CSV file
    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      const headers = lines[0].split(',').map(h => h.trim());
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for (let char of lines[i]) {
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current.trim());
        
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });
        data.push(row);
      }
      
      return data;
    }

    // Upload CSV file
    async function uploadCSV() {
      const fileInput = document.getElementById('csvFile');
      const status = document.getElementById('csvStatus');
      
      if (!fileInput.files.length) {
        showStatus(status, 'error', '‚ùå Please select a CSV file');
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      status.innerHTML = '<span class="loader"></span> Processing CSV file...';
      status.className = 'status info';
      
      reader.onload = async (e) => {
        try {
          const csvData = parseCSV(e.target.result);
          
          if (!csvData.length) {
            throw new Error('No data found in CSV file');
          }
          
          // Map CSV columns to Firestore fields
          const staffData = csvData.map(row => ({
            department: row['Department'] || '',
            office: row['Office'] || '',
            fullName: row['Full Name'] || '',
            postTitle: row['Post Title'] || '',
            officeTel: row['Office Tel'] || '',
            normalizedName: normalizeName(row['Full Name'] || ''),
            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
          }));
          
          // Batch upload to Firestore
          const batch = db.batch();
          
          staffData.forEach(staff => {
            const docRef = db.collection('staff').doc();
            batch.set(docRef, staff);
          });
          
          await batch.commit();
          
          showStatus(status, 'success', `‚úÖ Successfully uploaded ${staffData.length} staff records`);
          fileInput.value = '';
          
          // Reload data
          await loadAllData();
          
        } catch (error) {
          showStatus(status, 'error', `‚ùå Error: ${error.message}`);
        }
      };
      
      reader.readAsText(file);
    }

    // Upload posting notices
    async function uploadPostings() {
      const input = document.getElementById('jsonInput').value;
      const status = document.getElementById('postingStatus');
      
      if (!input.trim()) {
        showStatus(status, 'error', '‚ùå Please enter JSON data');
        return;
      }
      
      status.innerHTML = '<span class="loader"></span> Uploading postings...';
      status.className = 'status info';
      
      try {
        const data = JSON.parse(input);
        if (!Array.isArray(data)) {
          throw new Error('Data must be a JSON array');
        }
        
        const batch = db.batch();
        
        data.forEach(posting => {
          const docRef = db.collection('postings').doc();
          batch.set(docRef, {
            ...posting,
            normalizedName: normalizeName(posting.name || ''),
            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        
        await batch.commit();
        
        showStatus(status, 'success', `‚úÖ Successfully uploaded ${data.length} posting notices`);
        document.getElementById('jsonInput').value = '';
        
        // Reload data
        await loadAllData();
        
      } catch (error) {
        showStatus(status, 'error', `‚ùå Error: ${error.message}`);
      }
    }

    // Clear staff data
    async function clearStaffData() {
      if (!confirm('Are you sure you want to delete all staff data? This cannot be undone!')) {
        return;
      }
      
      const status = document.getElementById('csvStatus');
      status.innerHTML = '<span class="loader"></span> Clearing staff data...';
      status.className = 'status info';
      
      try {
        const snapshot = await db.collection('staff').get();
        const batch = db.batch();
        
        snapshot.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        showStatus(status, 'success', '‚úÖ All staff data cleared successfully');
        await loadAllData();
        
      } catch (error) {
        showStatus(status, 'error', `‚ùå Error: ${error.message}`);
      }
    }

    // Clear postings input
    function clearPostingsInput() {
      document.getElementById('jsonInput').value = '';
    }

    // Display staff in table
    function displayStaff() {
      const tbody = document.getElementById('staffTableBody');
      
      if (filteredStaff.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="no-results">No staff data found.</td></tr>';
        updatePagination();
        return;
      }
      
      const startIndex = (currentPage - 1) * rowsPerPage;
      const endIndex = startIndex + rowsPerPage;
      const pageData = filteredStaff.slice(startIndex, endIndex);
      
      tbody.innerHTML = pageData.map((staff, index) => {
        const postings = staffPostingsMap.get(staff.id) || [];
        const postingCount = postings.length;
        
        return `
          <tr onclick="viewStaffDetails('${staff.id}')" style="cursor: pointer;">
            <td>${startIndex + index + 1}</td>
            <td>${staff.fullName}</td>
            <td>${staff.postTitle}</td>
            <td>${staff.department}</td>
            <td>${staff.office || '-'}</td>
            <td>${staff.officeTel}</td>
            <td>
              ${postingCount > 0 ? 
                `<span class="posting-match">${postingCount} posting${postingCount > 1 ? 's' : ''}</span>` : 
                '-'
              }
            </td>
          </tr>
        `;
      }).join('');
      
      updatePagination();
    }

    // Display postings
    function displayPostings() {
      const tbody = document.getElementById('postingsTableBody');
      
      if (allPostings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="no-results">No posting notices available.</td></tr>';
        return;
      }
      
      // Show latest 50 postings
      const recentPostings = allPostings.slice(0, 50);
      
      tbody.innerHTML = recentPostings.map(posting => {
        // Check if posting matches any staff
        let staffMatch = 'No match';
        const postingNameVariations = createNameVariations(posting.name);
        
        for (let staff of allStaff) {
          const staffVariations = createNameVariations(staff.fullName);
          const hasMatch = postingNameVariations.some(pv => 
            staffVariations.some(sv => sv === pv)
          );
          
          if (hasMatch) {
            staffMatch = `<span class="posting-match">‚úì ${staff.fullName}</span>`;
            break;
          }
        }
        
        return `
          <tr>
            <td>${posting.dateFrom || 'N/A'}</td>
            <td>${posting.name || 'N/A'}</td>
            <td>${posting.rank || 'N/A'}</td>
            <td>${posting.from || 'N/A'}</td>
            <td>${posting.to || 'N/A'}</td>
            <td>${posting.noticeId || 'N/A'}</td>
            <td>${posting.remarks || '-'}</td>
            <td>${staffMatch}</td>
          </tr>
        `;
      }).join('');
    }

    // View staff details
    function viewStaffDetails(staffId) {
      const staff = allStaff.find(s => s.id === staffId);
      if (!staff) return;
      
      const postings = staffPostingsMap.get(staffId) || [];
      const modal = document.getElementById('staffModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      
      modalTitle.textContent = `Staff Details: ${staff.fullName}`;
      
      let html = `
        <div style="margin-bottom: 20px;">
          <h3 style="color: #2c3e50; margin-bottom: 15px;">Basic Information</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            <div>
              <strong>Full Name:</strong> ${staff.fullName}
            </div>
            <div>
              <strong>Post Title:</strong> ${staff.postTitle}
            </div>
            <div>
              <strong>Department:</strong> ${staff.department}
            </div>
            <div>
              <strong>Office:</strong> ${staff.office || 'N/A'}
            </div>
            <div>
              <strong>Office Tel:</strong> ${staff.officeTel}
            </div>
            <div>
              <strong>Normalized Name:</strong> ${normalizeName(staff.fullName)}
            </div>
          </div>
        </div>
      `;
      
      if (postings.length > 0) {
        html += `
          <div>
            <h3 style="color: #2c3e50; margin-bottom: 15px;">Posting History (${postings.length})</h3>
            <div style="max-height: 400px; overflow-y: auto;">
              <table style="width: 100%; font-size: 14px;">
                <thead>
                  <tr>
                    <th style="background: #3498db; color: white; padding: 8px;">Date</th>
                    <th style="background: #3498db; color: white; padding: 8px;">From</th>
                    <th style="background: #3498db; color: white; padding: 8px;">To</th>
                    <th style="background: #3498db; color: white; padding: 8px;">Notice ID</th>
                    <th style="background: #3498db; color: white; padding: 8px;">Remarks</th>
                  </tr>
                </thead>
                <tbody>
                  ${postings.map(p => `
                    <tr>
                      <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${p.dateFrom || 'N/A'}</td>
                      <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${p.from || 'N/A'}</td>
                      <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${p.to || 'N/A'}</td>
                      <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${p.noticeId || 'N/A'}</td>
                      <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${p.remarks || '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      } else {
        html += '<p style="color: #666;">No posting notices found for this staff member.</p>';
      }
      
      modalBody.innerHTML = html;
      modal.style.display = 'block';
    }

    // Close modal
    function closeModal() {
      document.getElementById('staffModal').style.display = 'none';
    }

    // Search functionality
    function performSearch() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const showPostingsOnly = document.getElementById('showPostingsOnly').checked;
      
      if (!searchTerm && !showPostingsOnly) {
        filteredStaff = [...allStaff];
      } else {
        filteredStaff = allStaff.filter(staff => {
          // Check if staff has postings
          const hasPostings = staffPostingsMap.has(staff.id);
          
          if (showPostingsOnly && !hasPostings) {
            return false;
          }
          
          if (!searchTerm) {
            return true;
          }
          
          return (
            (staff.fullName && staff.fullName.toLowerCase().includes(searchTerm)) ||
            (staff.postTitle && staff.postTitle.toLowerCase().includes(searchTerm)) ||
            (staff.department && staff.department.toLowerCase().includes(searchTerm)) ||
            (staff.office && staff.office.toLowerCase().includes(searchTerm))
          );
        });
      }
      
      currentPage = 1;
      displayStaff();
    }

    // Pagination
    function updatePagination() {
      const totalPages = Math.ceil(filteredStaff.length / rowsPerPage);
      
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    function previousPage() {
      if (currentPage > 1) {
        currentPage--;
        displayStaff();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredStaff.length / rowsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        displayStaff();
      }
    }

    // Switch tabs
    function switchTab(tabName) {
      // Remove active class from all tabs and contents
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Add active class to selected tab
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
    }

    // Show status message
    function showStatus(element, type, message) {
      element.textContent = message;
      element.className = `status ${type}`;
      
      setTimeout(() => {
        element.className = 'status';
      }, 5000);
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('staffModal');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    }
  </script>
</body>
</html>